<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem phim cùng Thiinh - Hoàn Chỉnh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for the new Purple Theme */
        :root {
            --primary-bg-color: #1A1625;
            --secondary-bg-color: #231E39;
            --card-bg-color: #2A2444;
            --accent-color: #9E78F0; /* Light Purple */
            --accent-color-hover: #B695F5;
            --text-primary-color: #F0F0F0;
            --text-secondary-color: #A09CB8;
            --border-color: #4A4266;
            --font-family: 'Be Vietnam Pro', sans-serif;
        }

        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--primary-bg-color);
            color: var(--text-primary-color);
            font-family: var(--font-family);
            line-height: 1.6;
            transition: background-color 0.3s;
        }

        /* --- Header --- */
        .site-header {
            background-color: var(--secondary-bg-color);
            padding: 0.75rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .site-branding {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }
        
        .site-logo-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            transition: transform 0.3s ease;
        }

        .site-branding:hover .site-logo-img {
            transform: rotate(360deg);
        }

        .site-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary-color);
            display: none; /* Hide text on small screens */
        }
        
        @media (min-width: 640px) {
            .site-title {
                display: block; /* Show text on larger screens */
            }
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-grow: 1;
            justify-content: center;
        }

        .main-nav {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .main-nav::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }


        .nav-link {
            color: var(--text-secondary-color);
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 500;
            padding: 0.5rem 0;
            border-bottom: 2px solid transparent;
            transition: color 0.3s, border-color 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .search-form {
            flex-grow: 1;
            max-width: 350px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg-color);
            color: var(--text-primary-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(158, 120, 240, 0.5);
        }

        /* --- Filters --- */
        .filters-container {
            background-color: var(--secondary-bg-color);
            padding: 1rem 2rem;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-select {
            background-color: var(--card-bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-select:hover {
            border-color: var(--accent-color);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* --- Main Content: Movie Grid --- */
        .main-content {
            padding: 2rem;
        }
        
        .results-header {
            margin-bottom: 1.5rem;
        }

        #results-count {
            color: var(--text-secondary-color);
            font-size: 1.1rem;
            font-weight: 400;
        }

        #results-count strong {
            color: var(--text-primary-color);
            font-weight: 500;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
        }

        .movie-card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border: 1px solid transparent;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(158, 120, 240, 0.2);
            border-color: var(--accent-color);
        }

        .movie-card img {
            width: 100%;
            height: auto;
            display: block;
            aspect-ratio: 2 / 3;
            object-fit: cover;
        }

        .movie-card-info {
            padding: 1rem;
        }

        .movie-card-title {
            font-size: 1rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary-color);
        }

        .movie-card-origin-name {
            font-size: 0.8rem;
            color: var(--text-secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Pagination --- */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 0;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .pagination-btn, .page-number {
            background-color: var(--card-bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1.1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 45px;
            text-align: center;
        }
        
        .page-ellipsis {
            padding: 0.6rem 0;
            color: var(--text-secondary-color);
        }

        .pagination-btn:hover:not(:disabled), .page-number:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            background-color: var(--primary-bg-color);
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }

        .page-number.active {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
            font-weight: 700;
        }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary-color);
            font-size: 0.9rem;
        }
        .site-footer a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }

        /* --- Movie Detail Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 22, 37, 0.85);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--secondary-bg-color);
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2.5rem;
            color: var(--text-secondary-color);
            cursor: pointer;
            z-index: 2010;
            line-height: 1;
            transition: color 0.2s, transform 0.2s;
        }
        
        .modal-close-btn:hover {
            color: var(--text-primary-color);
            transform: scale(1.1);
        }

        .modal-player-container {
            width: 100%;
            background-color: #000;
            position: relative;
            aspect-ratio: 16 / 9;
            max-height: 60vh;
        }

        .modal-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .modal-details-container {
            display: flex;
            flex-direction: row;
            padding: 2rem;
            gap: 2rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .modal-poster {
            flex-shrink: 0;
            width: 220px;
        }
        
        .modal-poster img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-info {
            flex-grow: 1;
        }

        .modal-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }
        
        .modal-origin-title {
            font-size: 1.2rem;
            color: var(--text-secondary-color);
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .modal-description {
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-secondary-color);
        }
        
        .modal-meta-item {
            margin-bottom: 0.5rem;
            color: var(--text-primary-color);
        }
        
        .modal-meta-item strong {
            color: var(--text-secondary-color);
            font-weight: 500;
            min-width: 90px;
            display: inline-block;
        }

        .episodes-list, .gemini-features {
            margin-top: 1.5rem;
        }

        .episodes-list h3, .gemini-features h3 {
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .episode-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .episode-btn {
            background-color: var(--card-bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .episode-btn:hover, .episode-btn.active {
            background-color: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }
        
        /* Gemini Features */
        .gemini-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(45deg, var(--accent-color), #c39eff);
            color: #fff;
            font-weight: 700;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .gemini-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(158, 120, 240, 0.4);
        }
        .gemini-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .gemini-output {
            background-color: var(--primary-bg-color);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-secondary-color);
            min-height: 50px;
            line-height: 1.7;
        }
        
        .gemini-output .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        .similar-movie-item {
            background-color: var(--primary-bg-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .similar-movie-item strong {
            color: var(--accent-color);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* --- Loader --- */
        .loader {
            text-align: center;
            padding: 4rem;
            font-size: 1.5rem;
            color: var(--text-secondary-color);
            width: 100%;
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .site-header {
                flex-direction: column;
            }
            .header-center {
                order: 1;
                width: 100%;
                justify-content: flex-start;
            }
            .search-form {
                order: 2;
                max-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .site-title {
                font-size: 1.5rem;
            }
            .filters-container {
                padding: 1rem;
                gap: 0.5rem;
                justify-content: space-around;
            }
            .filter-select {
                flex-grow: 1;
                text-align: center;
            }
            .main-content {
                padding: 1rem;
            }
            .movies-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 1rem;
            }
            .modal-details-container {
                flex-direction: column;
                padding: 1.5rem;
            }
            .modal-poster {
                width: 150px;
                margin: 0 auto;
            }
            .modal-title {
                font-size: 1.8rem;
            }
            .pagination {
                gap: 0.25rem;
            }
            .pagination-btn, .page-number {
                padding: 0.5rem 0.8rem;
                min-width: 40px;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="site-header">
        <a href="#" class="site-branding">
            <img src="https://i.imgur.com/WFtb3lw.png" alt="Logo" class="site-logo-img">
            <span class="site-title">Xem phim cùng Thiinh</span>
        </a>
        <div class="header-center">
             <nav class="main-nav" id="main-nav">
                <a href="#" class="nav-link active" data-type="phim-moi-cap-nhat">Trang Chủ</a>
                <a href="#" class="nav-link" data-type="phim-le">Phim Lẻ</a>
                <a href="#" class="nav-link" data-type="phim-bo">Phim Bộ</a>
                <a href="#" class="nav-link" data-type="tv-shows">TV Shows</a>
                <a href="#" class="nav-link" data-type="hoat-hinh">Hoạt Hình</a>
            </nav>
        </div>
        <form class="search-form" id="search-form">
            <input type="text" id="search-input" class="search-input" placeholder="Tìm kiếm phim...">
        </form>
    </header>

    <!-- Filters -->
    <nav class="filters-container">
        <select id="category-filter" class="filter-select">
            <option value="">Tất cả thể loại</option>
        </select>
        <select id="country-filter" class="filter-select">
            <option value="">Tất cả quốc gia</option>
        </select>
        <select id="year-filter" class="filter-select">
            <option value="">Tất cả năm</option>
        </select>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="results-header">
            <h2 id="results-count"></h2>
        </header>
        <div id="movies-grid" class="movies-grid">
            <!-- Movie cards will be inserted here by JavaScript -->
        </div>
    </main>

    <!-- Pagination -->
    <div class="pagination" id="pagination-container">
        <!-- Pagination will be dynamically generated here -->
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        © 2025 Xem phim cùng Thiinh - Powered by <a href="https://phimapi.com" target="_blank">phimapi.com</a>
    </footer>
    
    <!-- Movie Detail Modal -->
    <div id="movie-modal" class="modal-overlay">
        <div class="modal-content">
            <span id="modal-close-btn" class="modal-close-btn" aria-label="Đóng">&times;</span>
            <div class="modal-player-container">
                <iframe id="movie-player" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div id="modal-details-container" class="modal-details-container">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const moviesGrid = document.getElementById('movies-grid');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const categoryFilter = document.getElementById('category-filter');
            const countryFilter = document.getElementById('country-filter');
            const yearFilter = document.getElementById('year-filter');
            const paginationContainer = document.getElementById('pagination-container');
            const resultsCountEl = document.getElementById('results-count');
            const modal = document.getElementById('movie-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalDetailsContainer = document.getElementById('modal-details-container');
            const moviePlayer = document.getElementById('movie-player');
            const siteBranding = document.querySelector('.site-branding');
            const mainNav = document.getElementById('main-nav');

            // --- API Endpoints ---
            const API_BASE_URL = 'https://phimapi.com';
            const API_SEARCH = `${API_BASE_URL}/v1/api/tim-kiem`;
            const API_DETAIL = `${API_BASE_URL}/phim/`;
            const API_CATEGORIES = `${API_BASE_URL}/the-loai`;
            const API_COUNTRIES = `${API_BASE_URL}/quoc-gia`;
            
            // --- State ---
            let currentPage = 1;
            let currentView = 'browse'; // 'browse' or 'search'
            let currentBrowseType = 'phim-moi-cap-nhat';
            
            // --- Helper Functions ---
            
            /**
             * Fetches data from a given URL.
             * @param {string} url - The URL to fetch data from.
             * @returns {Promise<object|null>} - The JSON response or null on error.
             */
            async function fetchData(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("API Fetch Error: ", error);
                    moviesGrid.innerHTML = `<p class="loader">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.</p>`;
                    return null;
                }
            }
            
            /**
             * Calls the Gemini API with exponential backoff.
             * @param {object} payload - The payload to send to the API.
             * @param {number} maxRetries - Maximum number of retries.
             * @returns {Promise<object|null>} - The API response or null on failure.
             */
            async function callGeminiAPI(payload, maxRetries = 3) {
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                let attempt = 0;
                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API responded with status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0];
                        } else {
                            // Handle cases where the API returns a valid response but no candidates (e.g., safety blocks)
                            console.warn("Gemini API returned no candidates. Response:", result);
                            return null;
                        }
                    } catch (error) {
                        attempt++;
                        if (attempt >= maxRetries) {
                            console.error("Gemini API call failed after multiple retries:", error);
                            return null;
                        }
                        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                return null;
            }


            /**
             * Displays movies in the grid.
             * @param {Array} movies - An array of movie objects.
             */
            function renderMovies(movies) {
                moviesGrid.innerHTML = ''; // Clear previous results
                if (!movies || movies.length === 0) {
                    moviesGrid.innerHTML = `<p class="loader">Không tìm thấy phim phù hợp.</p>`;
                    return;
                }

                movies.forEach(movie => {
                    const movieCard = document.createElement('article');
                    movieCard.className = 'movie-card';
                    movieCard.dataset.slug = movie.slug;

                    movieCard.innerHTML = `
                        <img src="${movie.poster_url}" alt="${movie.name}" onerror="this.src='https://placehold.co/300x450/2A2444/F0F0F0?text=${encodeURIComponent(movie.name)}';">
                        <div class="movie-card-info">
                            <h3 class="movie-card-title">${movie.name}</h3>
                            <p class="movie-card-origin-name">${movie.origin_name} (${movie.year})</p>
                        </div>
                    `;
                    moviesGrid.appendChild(movieCard);
                });
            }

            /**
             * Updates the results count header.
             * @param {object} pagination - The pagination object from the API.
             * @param {number} itemsCount - The number of items on the current page.
             */
            function updateResultsHeader(pagination, itemsCount) {
                if(pagination && pagination.totalItems) {
                    resultsCountEl.innerHTML = `Hiển thị <strong>${itemsCount}</strong> trong tổng số <strong>${pagination.totalItems}</strong> phim`;
                } else {
                    resultsCountEl.innerHTML = `Đang hiển thị <strong>${itemsCount}</strong> phim mới nhất`;
                }
            }

            /**
             * Fetches movies from the API and displays them.
             * @param {string} url - The API URL to fetch movies from.
             */
            async function fetchAndDisplayMovies(url) {
                moviesGrid.innerHTML = `<p class="loader">Đang tải phim...</p>`;
                resultsCountEl.innerHTML = '';
                paginationContainer.innerHTML = '';

                const data = await fetchData(url);
                let items = null;
                let pagination = null;

                if (data) {
                    if (data.items) { // Default list structure
                        items = data.items;
                        pagination = data.pagination;
                    } else if (data.data && data.data.items) { // Search API structure
                        items = data.data.items;
                        pagination = data.data.params.pagination;
                    }
                }

                if(items) {
                    renderMovies(items);
                    updateResultsHeader(pagination, items.length);
                }
                
                if (pagination) {
                    currentPage = pagination.currentPage;
                    updatePagination(pagination);
                }
            }
            
            /**
             * Creates and updates the numbered pagination controls.
             * @param {object} pagination - The pagination object from the API.
             */
            function updatePagination({ currentPage, totalPages }) {
                paginationContainer.innerHTML = '';
                if (totalPages <= 1) return;

                const pages = [];
                const range = 2; // Number of pages to show around the current page

                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.textContent = '«';
                prevBtn.dataset.page = currentPage - 1;
                prevBtn.setAttribute('aria-label', 'Trang trước');
                if (currentPage === 1) prevBtn.disabled = true;
                pages.push(prevBtn);

                // Page numbers
                const pageNumbers = new Set();
                pageNumbers.add(1);
                for (let i = Math.max(2, currentPage - range); i <= Math.min(totalPages - 1, currentPage + range); i++) {
                    pageNumbers.add(i);
                }
                pageNumbers.add(totalPages);

                let lastPage = 0;
                pageNumbers.forEach(page => {
                    if (lastPage !== 0 && page - lastPage > 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'page-ellipsis';
                        ellipsis.textContent = '...';
                        pages.push(ellipsis);
                    }
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'page-number';
                    if (page === currentPage) pageBtn.classList.add('active');
                    pageBtn.textContent = page;
                    pageBtn.dataset.page = page;
                    pageBtn.setAttribute('aria-label', `Đi đến trang ${page}`);
                    pages.push(pageBtn);
                    lastPage = page;
                });

                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.textContent = '»';
                nextBtn.dataset.page = currentPage + 1;
                nextBtn.setAttribute('aria-label', 'Trang sau');
                if (currentPage === totalPages) nextBtn.disabled = true;
                pages.push(nextBtn);

                paginationContainer.append(...pages);
            }

            /**
             * Populates a select dropdown with options.
             * @param {HTMLElement} selectElement - The select element to populate.
             * @param {Array} items - Array of items with 'name' and 'slug' properties.
             * @param {string} defaultOptionText - The text for the default option.
             */
            function populateFilter(selectElement, items, defaultOptionText) {
                selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.slug;
                    option.textContent = item.name;
                    selectElement.appendChild(option);
                });
            }

            /**
             * Fetches and populates all filter dropdowns.
             */
            async function setupFilters() {
                const [categoriesData, countriesData] = await Promise.all([
                    fetchData(API_CATEGORIES),
                    fetchData(API_COUNTRIES)
                ]);

                if (categoriesData) populateFilter(categoryFilter, categoriesData, 'Tất cả thể loại');
                if (countriesData) populateFilter(countryFilter, countriesData, 'Tất cả quốc gia');

                const currentYear = new Date().getFullYear();
                const years = [];
                for (let year = currentYear; year >= 2010; year--) {
                    years.push({ name: `Năm ${year}`, slug: year });
                }
                populateFilter(yearFilter, years, 'Tất cả năm');
            }
            
            /**
             * Builds the URL for the current view and page.
             * @param {number} page - The page number to fetch.
             * @returns {string} The constructed API URL.
             */
            function buildUrl(page = 1) {
                const limit = 50; // Set the number of movies per page to 50
                if (currentView === 'search') {
                    const keyword = searchInput.value.trim();
                    const category = categoryFilter.value;
                    const country = countryFilter.value;
                    const year = yearFilter.value;
                    const params = new URLSearchParams({
                        keyword: keyword,
                        category: category,
                        country: country,
                        year: year,
                        page: page,
                        limit: limit
                    });
                    return `${API_SEARCH}?${params.toString()}`;
                } else { // 'browse' view
                    if (currentBrowseType === 'phim-moi-cap-nhat') {
                        return `${API_BASE_URL}/danh-sach/${currentBrowseType}?page=${page}&limit=${limit}`;
                    } else {
                        return `${API_BASE_URL}/v1/api/danh-sach/${currentBrowseType}?page=${page}&limit=${limit}`;
                    }
                }
            }

            /**
             * Handles search and filter submissions.
             */
            function handleFilterChange() {
                currentView = 'search';
                currentPage = 1;
                // Deactivate nav links when searching
                mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                const url = buildUrl(currentPage);
                fetchAndDisplayMovies(url);
            }
            
            /**
             * Fetches and displays movie details in the modal.
             * @param {string} slug - The movie slug.
             */
            async function showMovieDetails(slug) {
                modalDetailsContainer.innerHTML = `<p class="loader">Đang tải thông tin phim...</p>`;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';

                const data = await fetchData(`${API_DETAIL}${slug}`);
                if (data && data.movie) {
                    const movie = data.movie;
                    modalDetailsContainer.innerHTML = `
                        <div class="modal-poster">
                            <img src="${movie.poster_url}" alt="${movie.name}">
                        </div>
                        <div class="modal-info">
                            <h2 class="modal-title">${movie.name}</h2>
                            <h4 class="modal-origin-title">${movie.origin_name}</h4>
                            <div class="modal-description">${movie.content.replace(/<p>|<\/p>/g, "")}</div>
                            <div class="modal-meta">
                                <p class="modal-meta-item"><strong>Đạo diễn:</strong> ${movie.director.join(', ')}</p>
                                <p class="modal-meta-item"><strong>Diễn viên:</strong> ${movie.actor.join(', ')}</p>
                                <p class="modal-meta-item"><strong>Thể loại:</strong> ${movie.category.map(c => c.name).join(', ')}</p>
                                <p class="modal-meta-item"><strong>Quốc gia:</strong> ${movie.country.map(c => c.name).join(', ')}</p>
                            </div>
                            
                            <div class="gemini-features">
                                <h3>✨ Phân Tích bởi AI</h3>
                                <button id="gemini-summary-btn" class="gemini-btn">Tóm Tắt & Đánh Giá</button>
                                <div id="gemini-summary-output" class="gemini-output"></div>
                            </div>

                            <div class="episodes-list">
                                <h3>Danh sách tập</h3>
                                <div class="episode-buttons" id="episode-buttons">
                                    <!-- Episode buttons will be injected here -->
                                </div>
                            </div>
                            
                            <div class="gemini-features">
                                <h3>✨ Có Thể Bạn Cũng Thích</h3>
                                <div id="gemini-similar-output" class="gemini-output"></div>
                            </div>
                        </div>
                    `;
                    
                    const episodeButtonsContainer = document.getElementById('episode-buttons');
                    if (data.episodes && data.episodes[0] && data.episodes[0].server_data) {
                        data.episodes[0].server_data.forEach((ep, index) => {
                            const epBtn = document.createElement('button');
                            epBtn.className = 'episode-btn';
                            epBtn.textContent = ep.name;
                            epBtn.dataset.embedUrl = ep.link_embed;
                            episodeButtonsContainer.appendChild(epBtn);

                            if (index === 0) {
                                moviePlayer.src = ep.link_embed;
                                epBtn.classList.add('active');
                            }
                        });
                    } else {
                        episodeButtonsContainer.innerHTML = "<p>Chưa có tập phim nào.</p>";
                    }
                    
                    // Add event listener for the new Gemini button
                    document.getElementById('gemini-summary-btn').addEventListener('click', () => handleGeminiSummaryClick(movie));
                    
                    // Automatically fetch similar movies
                    fetchSimilarMovies(movie);


                } else {
                    modalDetailsContainer.innerHTML = `<p class="loader">Không thể tải thông tin phim.</p>`;
                }
            }
            
            /**
             * Handles the click on the Gemini summary button.
             * @param {object} movie - The movie object.
             */
            async function handleGeminiSummaryClick(movie) {
                const summaryBtn = document.getElementById('gemini-summary-btn');
                const outputDiv = document.getElementById('gemini-summary-output');

                summaryBtn.disabled = true;
                outputDiv.innerHTML = '<div class="spinner"></div>';

                const prompt = `Hãy đóng vai một nhà phê bình phim. Viết một đoạn tóm tắt ngắn gọn (2-3 câu, không tiết lộ nội dung) và một đoạn đánh giá nhanh (2-3 câu) về bộ phim "${movie.name}" (${movie.year}). Mô tả phim: "${movie.content.replace(/<p>|<\/p>/g, "")}". Chỉ trả về phần tóm tắt và đánh giá, không thêm lời chào.`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                const result = await callGeminiAPI(payload);

                if (result && result.text) {
                    outputDiv.innerHTML = result.text.replace(/\n/g, '<br>');
                } else {
                    outputDiv.textContent = "Không thể tạo tóm tắt vào lúc này. Vui lòng thử lại sau.";
                }
                summaryBtn.style.display = 'none'; // Hide button after use
            }
            
            /**
             * Fetches and displays similar movies using Gemini.
             * @param {object} movie - The movie object.
             */
            async function fetchSimilarMovies(movie) {
                const outputDiv = document.getElementById('gemini-similar-output');
                outputDiv.innerHTML = '<div class="spinner"></div>';
                
                const genresString = movie.category.map(c => c.name).join(', ');
                const prompt = `Dựa trên bộ phim "${movie.name}" (${movie.year}) thuộc thể loại ${genresString}, hãy đề xuất 3 bộ phim khác có phong cách hoặc nội dung tương tự. Với mỗi phim, hãy cung cấp tên phim và một câu giải thích ngắn gọn tại sao nó được đề xuất.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "recommendations": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "title": { "type": "STRING" },
                                            "reason": { "type": "STRING" }
                                        },
                                        required: ["title", "reason"]
                                    }
                                }
                            }
                        }
                    }
                };

                const result = await callGeminiAPI(payload);

                if (result && result.text) {
                    try {
                        const parsedJson = JSON.parse(result.text);
                        if (parsedJson.recommendations && parsedJson.recommendations.length > 0) {
                            outputDiv.innerHTML = '';
                            parsedJson.recommendations.forEach(rec => {
                                const item = document.createElement('div');
                                item.className = 'similar-movie-item';
                                item.innerHTML = `<strong>${rec.title}:</strong> ${rec.reason}`;
                                outputDiv.appendChild(item);
                            });
                        } else {
                             outputDiv.textContent = "Không tìm thấy gợi ý nào.";
                        }
                    } catch (e) {
                        console.error("Error parsing Gemini JSON response:", e);
                        outputDiv.textContent = "Không thể lấy gợi ý vào lúc này.";
                    }
                } else {
                    outputDiv.textContent = "Không thể lấy gợi ý vào lúc này. Vui lòng thử lại sau.";
                }
            }


            // --- Event Listeners ---
            
            siteBranding.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.reload();
            });

            mainNav.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.nav-link');
                if (!target) return;

                currentView = 'browse';
                currentBrowseType = target.dataset.type;
                currentPage = 1;

                // Reset search and filters
                searchInput.value = '';
                categoryFilter.value = '';
                countryFilter.value = '';
                yearFilter.value = '';

                mainNav.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                target.classList.add('active');

                const url = buildUrl(currentPage);
                fetchAndDisplayMovies(url);
            });

            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleFilterChange();
            });
            
            [categoryFilter, countryFilter, yearFilter].forEach(filter => {
                filter.addEventListener('change', handleFilterChange);
            });

            paginationContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target || target.disabled) return;
                
                const page = parseInt(target.dataset.page, 10);
                if (page && page !== currentPage) {
                    const url = buildUrl(page);
                    fetchAndDisplayMovies(url);
                    window.scrollTo(0, 0);
                }
            });
            
            moviesGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.movie-card');
                if (card && card.dataset.slug) {
                    showMovieDetails(card.dataset.slug);
                }
            });

            function closeModal() {
                if(modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                    moviePlayer.src = ''; // This stops video playback in an iframe
                }
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            modalDetailsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('episode-btn')) {
                    const embedUrl = e.target.dataset.embedUrl;
                    if (embedUrl) {
                        moviePlayer.src = embedUrl;
                        modalDetailsContainer.querySelectorAll('.episode-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                    }
                }
            });

            // --- Initial Load ---
            function initialize() {
                setupFilters();
                const initialUrl = buildUrl(1);
                fetchAndDisplayMovies(initialUrl);
            }

            initialize();
        });
    </script>
</body>
</html>
